name: Deploy Frontend (k9_frontend) to Azure App Service (Docker)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "k9_frontend/**"
      - ".github/workflows/deploy-frontend.yml"

jobs:
  build_push_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate deploy secrets (publish profile matches app-name)
        env:
          APP_NAME: ${{ secrets.AZURE_WEBAPP_NAME_FE }}
          PUBLISH_PROFILE_XML: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_FE }}
        run: |
          python - <<'PY'
          import os, sys
          import xml.etree.ElementTree as ET
          
          app = (os.environ.get("APP_NAME") or "").strip()
          xml = os.environ.get("PUBLISH_PROFILE_XML") or ""
          
          if not app:
            print("ERROR: AZURE_WEBAPP_NAME_FE is empty.")
            sys.exit(1)
          if not xml.strip():
            print("ERROR: AZURE_WEBAPP_PUBLISH_PROFILE_FE is empty.")
            sys.exit(1)
          
          try:
            root = ET.fromstring(xml)
          except Exception as e:
            print(f"ERROR: publish profile XML is not valid XML: {e}")
            sys.exit(1)
          
          profiles = root.findall(".//publishProfile") if root.tag != "publishProfile" else [root]
          publish_urls = [p.get("publishUrl", "") for p in profiles if p.get("publishUrl")]
          msdeploy_sites = [p.get("msdeploySite", "") for p in profiles if p.get("msdeploySite")]
          
          haystack = "\n".join(publish_urls + msdeploy_sites)
          if app not in haystack:
            print("ERROR: publish profile does not appear to belong to the configured app-name.")
            print(f"  app-name: {app}")
            if publish_urls:
              # safe to print hostnames; no credentials
              print("  publishUrl values found:")
              for u in publish_urls:
                print(f"    - {u}")
            if msdeploy_sites:
              print("  msdeploySite values found:")
              for s in msdeploy_sites:
                print(f"    - {s}")
            sys.exit(1)
          
          print(f"OK: publish profile looks consistent with app-name: {app}")
          PY

      - name: Log in to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: k9_frontend
          file: k9_frontend/Dockerfile
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/k9-frontend:main

      - name: Deploy to Azure Web App (container)
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME_FE }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_FE }}
          images: ${{ secrets.ACR_LOGIN_SERVER }}/k9-frontend:main

